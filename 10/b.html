<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Execution and Exceptions · Unfiltered</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='website'/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../js/groups.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>

<!--
<link rel="shortcut icon" href="../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>Unfiltered
</a>
<div class="version-number">
0.10.0-M8
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../01.html" class="page">Try Unfiltered</a></li>
  <li><a href="../02.html" class="page">Plans and Intents</a></li>
  <li><a href="../03.html" class="page">Bindings and Servers</a></li>
  <li><a href="../04.html" class="page">Project Setup</a></li>
  <li><a href="../05.html" class="page">Community</a></li>
  <li><a href="../06/00.html" class="page">Matching and Responding</a>
  <ul>
    <li><a href="../06/a.html" class="page">Request Matchers</a></li>
    <li><a href="../06/b.html" class="page">Within the Parameters</a></li>
    <li><a href="../06/c.html" class="page">Response Functions</a></li>
    <li><a href="../06/d.html" class="page">Silly Store</a></li>
  </ul></li>
  <li><a href="../07/00.html" class="page">Directives and Validation</a>
  <ul>
    <li><a href="../07/a.html" class="page">Directive Intent</a></li>
    <li><a href="../07/b.html" class="page">Parameters as Directives</a></li>
    <li><a href="../07/c.html" class="page">Interpreter Reuse and Implicits</a></li>
    <li><a href="../07/d.html" class="page">Required Parameters</a></li>
    <li><a href="../07/e.html" class="page">Independent Failure</a></li>
    <li><a href="../07/f.html" class="page">Interpreters of Your Own Design</a></li>
    <li><a href="../07/g.html" class="page">Let&rsquo;s wrap this up, Ada</a></li>
  </ul></li>
  <li><a href="../08/00.html" class="page">Application Structure</a>
  <ul>
    <li><a href="../08/a.html" class="page">Planning for Any-thing</a></li>
    <li><a href="../08/b.html" class="page">Just Kitting</a></li>
  </ul></li>
  <li><a href="../09/00.html" class="page">Identification and Cookies</a>
  <ul>
    <li><a href="../09/a.html" class="page">Who&rsquo;s Who</a></li>
    <li><a href="../09/b.html" class="page">Remembrance of Things Past</a></li>
  </ul></li>
  <li><a href="../10/00.html" class="page">Netty Plans</a>
  <ul>
    <li><a href="../10/a.html" class="page">Trying Netty</a></li>
    <li><a href="../10/b.html" class="active page">Execution and Exceptions</a></li>
    <li><a href="../10/c.html" class="page">Chunked Requests</a></li>
    <li><a href="../10/d.html" class="page">Going Asynchronous</a></li>
    <li><a href="../10/e.html" class="page">Asyncrazy Temperature Server</a></li>
  </ul></li>
  <li><a href="../11.html" class="page">Jetty Extras</a></li>
  <li><a href="../12.html" class="page">ScalaTest</a></li>
  <li><a href="../99.html" class="page">Who&rsquo;s Using Unfiltered?</a></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../index.html">Unfiltered</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>Unfiltered
</a>
<div class="version-number">
0.10.0-M8
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../01.html" class="page">Try Unfiltered</a></li>
  <li><a href="../02.html" class="page">Plans and Intents</a></li>
  <li><a href="../03.html" class="page">Bindings and Servers</a></li>
  <li><a href="../04.html" class="page">Project Setup</a></li>
  <li><a href="../05.html" class="page">Community</a></li>
  <li><a href="../06/00.html" class="page">Matching and Responding</a>
  <ul>
    <li><a href="../06/a.html" class="page">Request Matchers</a></li>
    <li><a href="../06/b.html" class="page">Within the Parameters</a></li>
    <li><a href="../06/c.html" class="page">Response Functions</a></li>
    <li><a href="../06/d.html" class="page">Silly Store</a></li>
  </ul></li>
  <li><a href="../07/00.html" class="page">Directives and Validation</a>
  <ul>
    <li><a href="../07/a.html" class="page">Directive Intent</a></li>
    <li><a href="../07/b.html" class="page">Parameters as Directives</a></li>
    <li><a href="../07/c.html" class="page">Interpreter Reuse and Implicits</a></li>
    <li><a href="../07/d.html" class="page">Required Parameters</a></li>
    <li><a href="../07/e.html" class="page">Independent Failure</a></li>
    <li><a href="../07/f.html" class="page">Interpreters of Your Own Design</a></li>
    <li><a href="../07/g.html" class="page">Let&rsquo;s wrap this up, Ada</a></li>
  </ul></li>
  <li><a href="../08/00.html" class="page">Application Structure</a>
  <ul>
    <li><a href="../08/a.html" class="page">Planning for Any-thing</a></li>
    <li><a href="../08/b.html" class="page">Just Kitting</a></li>
  </ul></li>
  <li><a href="../09/00.html" class="page">Identification and Cookies</a>
  <ul>
    <li><a href="../09/a.html" class="page">Who&rsquo;s Who</a></li>
    <li><a href="../09/b.html" class="page">Remembrance of Things Past</a></li>
  </ul></li>
  <li><a href="../10/00.html" class="page">Netty Plans</a>
  <ul>
    <li><a href="../10/a.html" class="page">Trying Netty</a></li>
    <li><a href="../10/b.html" class="active page">Execution and Exceptions</a></li>
    <li><a href="../10/c.html" class="page">Chunked Requests</a></li>
    <li><a href="../10/d.html" class="page">Going Asynchronous</a></li>
    <li><a href="../10/e.html" class="page">Asyncrazy Temperature Server</a></li>
  </ul></li>
  <li><a href="../11.html" class="page">Jetty Extras</a></li>
  <li><a href="../12.html" class="page">ScalaTest</a></li>
  <li><a href="../99.html" class="page">Who&rsquo;s Using Unfiltered?</a></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../index.html">Unfiltered</a></li>
  <li><a href="../10/00.html">Netty Plans</a></li>
  <li>Execution and Exceptions</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h2><a href="#execution-and-exceptions" name="execution-and-exceptions" class="anchor"><span class="anchor-link"></span></a>Execution and Exceptions</h2>
<p>That&rsquo;s pretty nifty how we started up a Netty server in a few lines of code, just like with Jetty, right? But while <code>Planify</code> is really handy for experimenting in the console, it makes a lot of assumptions that are unlikely to hold for a live server.</p>
<h3><a href="#a-less-simple-plan" name="a-less-simple-plan" class="anchor"><span class="anchor-link"></span></a>A Less Simple Plan</h3>
<p>Let&rsquo;s see what the plan looks like with those defaults made explicit.</p>
<pre class="prettyprint"><code class="language-scala">import unfiltered.netty._

trait MyPlan extends cycle.Plan with
cycle.ThreadPool with ServerErrorResponse

object Hello extends MyPlan {
  def intent = {
    case _ =&gt; ResponseString(&quot;hello world&quot;)
  }
}
</code></pre>
<p>The traits define methods needed by <code>cycle.Plan</code>. But what for?</p>
<h3><a href="#deferred-execution" name="deferred-execution" class="anchor"><span class="anchor-link"></span></a>Deferred Execution</h3>
<p>Netty handlers are invoked on an I/O worker thread. In some scenarios (including this one, actually) it would be just fine to prepare a response on this thread. If the work is CPU-bound (does not perform blocking operations), you can mix in the <code>cycle.SynchronousExecution</code> trait instead, for no-overhead execution.</p>
<p>But a typical web application does need to access a database or <em>something</em>, and the typical way to do this is with a blocking call. That&rsquo;s why <code>Planify</code> uses the <code>cycle.ThreadPool</code> trait, which defers application of the intent partial function to a cached thread pool.</p>
<h3><a href="#deference-has-its-memory-limits" name="deference-has-its-memory-limits" class="anchor"><span class="anchor-link"></span></a>Deference has its Memory Limits</h3>
<p>Unfortunately, that&rsquo;s not the end of the story with deferred execution. Applications also need to worry about running out of memory. If you defer request handling jobs to an executor queue as fast as Netty can accept requests, any heap limit can be exceeded with a severe enough usage spike.</p>
<p>To avoid that kind of failure, you should equip your plans with an executor that consumes a limited amount of memory and blocks on incoming requests when that limit is reached. If you&rsquo;ve defined a simple local base plan (like the <code>MyPlan</code> above), you can customize it later (ideally, before your server throws an out of memory exception) with a memory-aware thread pool executor.</p>
<pre class="prettyprint"><code class="language-scala">trait MyPlan extends cycle.Plan with
cycle.DeferralExecutor with cycle.DeferredIntent with
ServerErrorResponse {
  def underlying = MyExecutor.underlying
}
object MyExecutor {
  import org.jboss.netty.handler.execution._
  lazy val underlying = new MemoryAwareThreadPoolExecutor(
    16, 65536, 1048576)
}
</code></pre>
<h3><a href="#expecting-exceptions" name="expecting-exceptions" class="anchor"><span class="anchor-link"></span></a>Expecting Exceptions</h3>
<p>The <code>ServerErrorResponse</code> trait also implements behavior that your application will likely need to customize, sooner or later. Instead of mixing in that trait, you can implement <code>onException</code> directly in your base plan. For a starting point see the source for the <a href="https://github.com/unfiltered/Unfiltered/blob/master/netty/src/main/scala/exceptions.scala#L15">provided exception handler</a>, which logs the stack trace to stdout and serves a very terse error response. Normally an application will hook into its own logger and serve a custom error page or redirect.</p>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/unfiltered/website/tree/v0.10.0-M8/src/paradox/10/b.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../10/c.html">Chunked Requests</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../10/b.html#execution-and-exceptions" class="header">Execution and Exceptions</a>
  <ul>
    <li><a href="../10/b.html#a-less-simple-plan" class="header">A Less Simple Plan</a></li>
    <li><a href="../10/b.html#deferred-execution" class="header">Deferred Execution</a></li>
    <li><a href="../10/b.html#deference-has-its-memory-limits" class="header">Deference has its Memory Limits</a></li>
    <li><a href="../10/b.html#expecting-exceptions" class="header">Expecting Exceptions</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2020</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '0.10.0-M8', '')});</script>


</html>
